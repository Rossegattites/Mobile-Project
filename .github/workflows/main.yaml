name: Mobile E2E Tests (Android CI)

on: pull_request

jobs: 
  continuous-integration:
    runs-on: ubuntu-latest

    steps:
      
      # 1. Basic Setup
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4 
        with:
          node-version: '20.x'
          
      - name: Install Dependencies
        run: npm install
      
      - name: Setup Java Environment (Required for Gradle)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin' 
          java-version: '17'
          cache: 'gradle'
          cache-dependency-path: 'app/android/settings.gradle'
      - name: Build Android App (Assemble Debug)
        run: ./gradlew assembleDebug
        working-directory: 'app/android'
      # 2. Android Emulator Setup and Start
      - name: Setup Android SDK and Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30 
          target: default
          profile: Pixel 3
          timeout-in-minutes: 10
          
          script: |
            echo "Waiting for emulator to boot..."
            adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done;'
            echo "Emulator booted!"

          emulator-options: -memory 4096 -no-snapshot-save -no-window -gpu swiftshader_indirect
          disable-animations: true 
      # 3. Start Appium and Run Tests
      - name: Start Appium Server and Run Tests
        run: |
          npm install -g appium
          appium & # Starts Appium Server in the background on port 4723
          npx wait-on http://127.0.0.1:4723 -t 60000 # Wait for Appium to be available
          
          npm run build || true # Build command (optional, kept for robustness)
          npm run test # Executes WebdriverIO tests (wdio.conf.ts)