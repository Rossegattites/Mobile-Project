name: Mobile E2E Tests (Android CI)

on: pull_request

jobs: 
  continuous-integration:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
    steps:
      
      # 1. Basic Setup
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4 
        with:
          node-version: '20.x'
          
      - name: Install Dependencies
        run: npm install
      
      # 2. Android Emulator Setup and Start
      - name: Manual Android/Emulator Setup
        run: |
          export PATH="$PATH:$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin"
          
          # 1. Install Platform Tools, Build Tools, and SDK 30 packages
          sdkmanager "platform-tools" "platforms;android-30" "build-tools;30.0.3"

          # 2. Install the necessary System Image (Google APIs is often more reliable)
          sdkmanager "system-images;android-30;google_apis;x86"

          # 3. Create the Android Virtual Device (AVD)
          echo "no" | avdmanager create avd -n TestDevice -k "system-images;android-30;google_apis;x86"
          
          # 4. Start the Emulator in background using nohup for stability
          nohup $ANDROID_SDK_ROOT/emulator/emulator -avd TestDevice -no-window -no-audio -gpu swiftshader_indirect &

          # 5. Wait for ADB to be fully initialized
          adb wait-for-device
          # Unlock the screen
          adb shell input keyevent 82 
          
          echo "Emulator is ready and unlocked."

      # 3. Start Appium and Run Tests
      - name: Start Appium Server and Run Tests
        run: |
          npm install -g appium
          
          adb wait-for-device 
          
          adb shell input keyevent 82

          appium & # Starts Appium Server in the background on port 4723
          npx wait-on http://127.0.0.1:4723 -t 60000 # Wait for Appium
          
          npm run test