name: Mobile E2E Tests (Android CI)

on: pull_request

jobs: 
  continuous-integration:
    runs-on: ubuntu-latest
    
    # Define a custom environment variable for the Android SDK root location
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

    steps:
      
      # 1. Basic Setup
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4 
        with:
          node-version: '20.x'
          
      - name: Install Dependencies
        # Install project dependencies
        run: npm install
        
      # 2. Manual Android/Emulator Setup
      - name: Manual Android/Emulator Setup
        run: |
          # Add the necessary SDK directories to the PATH
          export PATH="$PATH:$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin"
          
          # --- AVD Path Correction (Fixes ERROR | Unknown AVD name) ---
          # 1. Define ANDROID_AVD_HOME explicitly for avdmanager to save the AVD configuration here.
          export ANDROID_AVD_HOME=$HOME/.android/avd
          echo "ANDROID_AVD_HOME set to: $ANDROID_AVD_HOME"
          
          # 2. Ensure the AVD configuration directory exists.
          mkdir -p "$ANDROID_AVD_HOME"
          echo "Directory created/verified at: $ANDROID_AVD_HOME"
          
          # --- SDK Installation ---
          # 3. Accept all licenses automatically.
          yes | sdkmanager --licenses
          
          # Install modern SDK packages for better performance and compatibility.
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          
          # Install the system image (x86_64 for fast emulation with KVM)
          sdkmanager "system-images;android-34;google_apis;x86_64"

          # 4. Create the Android Virtual Device (AVD).
          #    avdmanager will use the ANDROID_AVD_HOME path set above.
          avdmanager create avd \
            --name "TestDevice" \
            --package "system-images;android-34;google_apis;x86_64" \
            --device "pixel_3a" \
            --force

      # 3. Start Emulator (Dedicated step for the KVM fix and stability)
      - name: Start Android Emulator
        run: |
          # --- KVM Permission Fix (Fixes KVM: Permission denied) ---
          # 1. Create a udev rule to grant full access (MODE="0666") to the /dev/kvm device.
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          echo "KVM permissions granted."
          
          # Re-export crucial environment variables for this step's context
          export PATH="$PATH:$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin"
          export ANDROID_AVD_HOME=$HOME/.android/avd
          
          # 2. Start the Emulator in the background using nohup and hardware acceleration (-gpu swiftshader_indirect).
          echo "Starting emulator..."
          nohup ${ANDROID_SDK_ROOT}/emulator/emulator -avd TestDevice -no-window -no-audio -gpu swiftshader_indirect -no-cache &
          
          # 3. Wait for ADB to be fully initialized (up to 300 seconds)
          echo "Waiting for device to be online..."
          timeout 300 adb wait-for-device
          
          # 4. Check status and handle timeout failure
          if [ $? -ne 0 ]; then
            echo "::error::Emulator failed to start within 300 seconds."
            killall emulator || true 
            exit 1
          fi
          
          # 5. Unlock the screen
          echo "Unlocking device..."
          adb shell input keyevent 82 
          
          echo "Emulator is ready and unlocked."
          
      # 4. Start Appium and Run Tests
      - name: Start Appium Server and Run Tests
        run: |
          # Install Appium
          npm install -g appium
          
          # Start Appium Server in the background
          appium & 
          
          # Wait for Appium to be ready
          npx wait-on http://127.0.0.1:4723 -t 60000 
          
          # Run the E2E tests
          npm run test