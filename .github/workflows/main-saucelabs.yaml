name: Mobile E2E Tests (Android CI)

on: pull_request

jobs: 
  continuous-integration:
    runs-on: ubuntu-latest
    
    # Define a custom environment variable for the Android SDK root location
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

    steps:
      
      # 1. Basic Setup
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4 
        with:
          node-version: '20.x'
          
      - name: Install Dependencies
        # Install project dependencies
        run: npm install
        
      # 2. Manual Android/Emulator Setup
      - name: Manual Android/Emulator Setup
        run: |
          # Add the necessary SDK directories to the PATH
          export PATH="$PATH:$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin"
          
          # --- AVD Path Correction ---
          # 1. Define ANDROID_AVD_HOME explicitly for avdmanager to save the AVD configuration here.
          export ANDROID_AVD_HOME=$HOME/.android/avd
          echo "ANDROID_AVD_HOME set to: $ANDROID_AVD_HOME"
          
          # 2. Ensure the AVD configuration directory exists.
          mkdir -p "$ANDROID_AVD_HOME"
          echo "Directory created/verified at: $ANDROID_AVD_HOME"
          
          # --- SDK Installation ---
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          sdkmanager "system-images;android-34;google_apis;x86_64"

          # 3. Create the Android Virtual Device (AVD).
          avdmanager create avd \
            --name "TestDevice" \
            --package "system-images;android-34;google_apis;x86_64" \
            --device "pixel_3a" \
            --force

          # --- CRITICAL FIX FOR TIMEOUT (EXIT CODE 124) ---
          # 4. Inject RAM and VM Heap settings into the AVD configuration file (.ini).
          #    This forces the emulator to use more memory, reducing the boot time.
          #    Using 2GB (2048M) is a reliable size for CI runners.
          echo "hw.ramSize=2048M" >> $ANDROID_AVD_HOME/TestDevice.ini
          echo "vm.heapSize=256M" >> $ANDROID_AVD_HOME/TestDevice.ini
          echo "Configured AVD RAM settings."

      # 3. Start Emulator (Dedicated step for KVM fix and stability)
      - name: Start Android Emulator
        run: |
          # --- KVM Permission Fix (Necessary for fast boot) ---
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          echo "KVM permissions granted."
          
          # Re-export crucial environment variables
          export PATH="$PATH:$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin"
          export ANDROID_AVD_HOME=$HOME/.android/avd
          
          # 2. Start the Emulator in the background.
          echo "Starting emulator..."
          nohup ${ANDROID_SDK_ROOT}/emulator/emulator -avd TestDevice -no-window -no-audio -gpu swiftshader_indirect -no-cache &
          
          # 3. Wait for ADB to be fully initialized (up to 300 seconds)
          echo "Waiting for device to be online..."
          timeout 300 adb wait-for-device
          
          # 4. Check status and handle timeout failure
          if [ $? -ne 0 ]; then
            echo "::error::Emulator failed to start within 300 seconds. Check KVM and RAM settings."
            killall emulator || true 
            exit 1
          fi
          
          # 5. Unlock the screen
          echo "Unlocking device..."
          adb shell input keyevent 82 
          
          echo "Emulator is ready and unlocked."
          
      # 4. Start Appium and Run Tests
      - name: Start Appium Server and Run Tests
        run: |
          # --- CRITICAL FIX FOR TS-NODE/ESM ERROR ---
          # This tells Node.js to use the ts-node loader for ESM files, solving the "did not call the next hook" error.
          export NODE_OPTIONS="--loader ts-node/esm"
          echo "NODE_OPTIONS set for ts-node/esm loading."
          
          # Install Appium
          npm install -g appium
          
          # Start Appium Server in the background
          appium & 
          
          # Wait for Appium to be ready
          npx wait-on http://127.0.0.1:4723 -t 60000 
          
          # Run the E2E tests
          npm run wdio